---
title: "NBA Application"
author: "Alessandro Colombi"
date: "15/6/2022"
output: pdf_document
---


```{r 11_setup, include=FALSE, purl=FALSE}
knitr::opts_chunk$set(eval = T)
```

```{r message=FALSE, include=TRUE}
library(GDFMM)
library(ACutils)
library(tidyverse)
```

Read data
```{r}
data <- read.csv("C:/Users/colom/OneDrive/GDFMM/tests/nba_salaries_with_position.csv")
```

Elementary analysis
```{r}
data = as_tibble(data)
data = data %>% 
       mutate(position = as.factor(position)) %>%  
       mutate(salary = as.double(salary)/10^6) %>%
       filter(player %in% unique(player)) #perdo i fratelli

# get levels
data_PG = filter(data, position == "PG") %>% select(player, salary)
data_SG = filter(data, position == "SG") %>% select(player, salary)
data_SF = filter(data, position == "SF") %>% select(player, salary)
data_PF = filter(data, position == "PF") %>% select(player, salary)
data_C = filter(data, position == "C") %>% select(player, salary)

n = nrow(data)
n_j = c( nrow(data_PG), nrow(data_SG), nrow(data_SF), nrow(data_PF), nrow(data_C) )
d = length(n_j) #5

# jittering
data_PG$salary = data_PG$salary  + rnorm(n = n_j[1],sd=0.001)
data_SG$salary  = data_SG$salary  + rnorm(n = n_j[2],sd=0.001)
data_SF$salary  = data_SF$salary  + rnorm(n = n_j[3],sd=0.001)
data_PF$salary  = data_PF$salary  + rnorm(n = n_j[4],sd=0.001)
data_C$salary  = data_C$salary  + rnorm(n = n_j[5],sd=0.001)

n_max = max(n_j)
data_matrix = matrix(NA, nrow = d, ncol = n_max) # d x max(n_j) matrix
cluster = matrix(NA, nrow = d, ncol = n_max)     # d x max(n_j) matrix
real_partition = c(
  rep(0,n_j[1]),rep(1,n_j[2]), rep(2,n_j[3]), rep(3,n_j[4]), rep(4,n_j[5])
)

data_matrix[1,1:n_j[1]] = data_PG$salary
data_matrix[2,1:n_j[2]] = data_SG$salary
data_matrix[3,1:n_j[3]] = data_SF$salary
data_matrix[4,1:n_j[4]] = data_PF$salary
data_matrix[5,1:n_j[5]] = data_C$salary
```
Data visualization
```{r}
d_PG = density(data_PG$salary)
par(mfrow=c(1,2))
plot(d_PG$x, d_PG$y, type = 'l', lty = 1, lwd = 2)
hist(data_PG$salary)

d_SG = density(data_SG$salary)
par(mfrow=c(1,2))
plot(d_SG$x, d_SG$y, type = 'l', lty = 1, lwd = 2)
hist(data_SG$salary)

d_SF = density(data_SF$salary)
par(mfrow=c(1,2))
plot(d_SF$x, d_SF$y, type = 'l', lty = 1, lwd = 2)
hist(data_SF$salary)

d_PF = density(data_PF$salary)
par(mfrow=c(1,2))
plot(d_PF$x, d_PF$y, type = 'l', lty = 1, lwd = 2)
hist(data_PF$salary)

d_C = density(data_C$salary)
par(mfrow=c(1,2))
plot(d_C$x, d_C$y, type = 'l', lty = 1, lwd = 2)
hist(data_C$salary)

```


## RUN
```{r}

niter  <- 3000
burnin <- 0
thin   <- 1


option = set_options(
             "nu" = 1, "Mstar0" = 2, "Lambda0" = 3, "mu0" = 0,"sigma0"= 1, "gamma0" = 1,
             "Adapt_MH_hyp1"= 0.7,"Adapt_MH_hyp2"= 0.234, "Adapt_MH_power_lim"=10, "Adapt_MH_var0"=1,
             "k0"= 1/10, "nu0"=10, "alpha_gamma"=1,
             "beta_gamma"=1, "alpha_lambda"=10, "beta_lambda"=1/10,
             "UpdateU" = T, "UpdateM" = T, "UpdateGamma" = T, "UpdateS" = T,
             "UpdateTau" = T, "UpdateLambda" = T
        )

GDFMM = GDFMM_sampler(data_matrix, niter, burnin, thin, seed = 123, FixPartition = F, option = option)


#K
plot(GDFMM$K, type = 'l', main = "K")
hist(GDFMM$K, main = "K")

#Mstar
plot(GDFMM$Mstar, type = 'l', main = "Mstar")

# Predictive --------------------------------------------------------------

l_grid = 200
grid = seq(0,50,length.out = l_grid)

# Predictive in all groups
Pred_all = predictive_all_groups(grid = grid, fit = GDFMM)
par(mfrow = c(2,3))
for(j in 1:d){
  hist(data_matrix[j,], freq = F, breaks = l_grid/10, col = ACutils::t_col("darkred", 70), xlim = range(grid),
             main = paste0("level = ",j))
  matplot(x = grid, y = t(Pred_all[[j]]), type = 'l', col = 'black', lty = 1, lwd = 2, add = T)
  points(x = data_matrix[j,], y = rep(0, length(data_matrix[j,])), pch = 16, col = ACutils::t_col("darkred", 10))

}
```












